<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Related Demo</title>
</head>
<body>
<h1>Related Demo</h1>
<table>
	<tr>
		<td valign="top">
			<fieldset>
				<legend>users (<span data-bind="text: itemsCount"></span> total)</legend>
				<input type="search" data-bind="value: usersFilter, valueUpdate: 'input'" />
				<div data-bind="foreach: filteredUsers">
					<div>
						<a href="#" data-bind="text: $data, click: $root.selectUser"></a>
					</div>
				</div>
			</fieldset>
			<div data-bind="if: selectedUser">
				<fieldset>
					<legend>user <span data-bind="text: selectedUser"></span> items</legend>
					<div data-bind="foreach: selectedUserItems">
						<div>
							<a href="#" data-bind="text: $data, click: $root.selectItem"></a>
						</div>
					</div>
				</fieldset>
			</div>
		</td>
		<td valign="top">
			<fieldset>
				<legend>items (<span data-bind="text: usersCount"></span> total)</legend>
				<input type="search" data-bind="value: itemsFilter, valueUpdate: 'input'" />
				<div data-bind="foreach: filteredItems">
					<div>
						<a href="#" data-bind="text: $data, click: $root.selectItem"></a>
					</div>
				</div>
			</fieldset>
			<div data-bind="if: selectedItem">
				<fieldset>
					<legend>item <span data-bind="text: selectedItem"></span> users</legend>
					<div data-bind="foreach: selectedItemUsers">
						<div>
							<a href="#" data-bind="text: $data, click: $root.selectUser"></a>
						</div>
					</div>
				</fieldset>
			</div>
		</td>
		<td valign="top" data-bind="if: selectedItem">
			<fieldset>
				<legend>item <span data-bind="text: selectedItem"></span> related</legend>
				<div data-bind="foreach: related">
					<div>
						<a href="#" data-bind="text: item, click: $root.selectItem"></a>
						<span data-bind="text: score" title="score"></span>
					</div>
				</div>
			</fieldset>
		</td>
	</tr>
</table>


<script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.2.1/jquery.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/knockout/3.4.2/knockout-debug.js"></script>
<script>
	function Model() {
		let model = this

		model.users = ko.observableArray()
		model.items = ko.observableArray()
		model.related = ko.observableArray()

		model.usersCount = ko.computed(() => model.users().length)
		model.itemsCount = ko.computed(() => model.items().length)

		model.usersFilter = ko.observable('')
		model.itemsFilter = ko.observable('')

		model.filteredUsers = ko.computed(function () {
			var filter = model.usersFilter()
			if (!filter) return model.users().slice(0, 10)

			return model.users().filter(u => u.indexOf(filter) === 0).slice(0, 10)
		})

		model.filteredItems = ko.computed(function () {
			var filter = model.itemsFilter()
			if (!filter) return model.items().slice(0, 10)

			return model.items().filter(u => u.indexOf(filter) === 0).slice(0, 10)
		})

		model.selectedUser = ko.observable()
		model.selectedUserItems = ko.observableArray()
		model.selectUser = user => {
			jQuery.getJSON('/user/' + user).then(items => {
				model.selectedUser(user)
				model.selectedUserItems(items)
			})
		}

		model.selectedItem = ko.observable()
		model.selectedItemUsers = ko.observableArray()
		model.selectItem = item => {
			jQuery.getJSON('/item/' + item).then(users => {
				model.selectedItem(item)
				model.selectedItemUsers(users)
			})

			jQuery.getJSON('/item/' + item + '/related').then(related => {
				model.related(related)
			})
		}

		model.loadUsers = () => jQuery.getJSON('/user').then(users => model.users(users))
		model.loadItems = () => jQuery.getJSON('/item').then(items => model.items(items))

		model.init = () => {
			model.loadUsers()
			model.loadItems()
		}

		model.init()
	}

	let model = new Model()
	ko.applyBindings(model)
</script>
</body>
</html>
